<!DOCTYPE html>
<link rel="shortcut icon" href="//monitor.sz.lan/meal_planner/static/favicon.png">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//monitor.sz.lan/resources/w3.css">
<link rel="stylesheet" href="//monitor.sz.lan/resources/w3-colors-2017.css">
<link rel="stylesheet" href="//monitor.sz.lan/resources/w3-colors-highway.css">
<link rel="stylesheet" href="//monitor.sz.lan/resources/font-awesome.min.css">
<script src="//monitor.sz.lan/resources/monitor.js"></script>
<html>
<head>
<style>
.fixed-footer {
   position: fixed;
   left: 0;
   bottom: 0;
   width: 100%;
   background-color: #4CAF50;
   color: white;
   text-align: center;
}
</style>
<title>每日食谱[{{username}}]</title>
  <script>
    window.onload = function() { logUserActivity('[meal-planner/index] load', '{{username}}'); checkDifference(); showDailyReminder(); };
    window.onunload = function() { logUserActivity('[meal-planner/index] unload', '{{username}}'); };
  </script>
</head>
<body>
<div class="w3-container w3-responsive" style="max-width: 50em; padding:0.75rem; display: block; margin-left: auto; margin-right: auto;">
  <span class="w3-right" style="margin-bottom:1rem;font-size:1em;">当前用户：[{{username}}]，<a href="#" onclick="logout();">退出登陆</a></span>
  <button onclick="window.open('./history/');" class="w3-button w3-block w3-left-align w3-green" style="margin-top:0.35em;">查询历史食谱...
  {% set textarea_heights = [3, 3, 3, 3, 3, 1] %}
	{%for i in range(0, day_strings|length)%} 
  <button onclick="accordionHandler('{{i}}')" class="w3-button w3-block w3-left-align w3-green" style="margin-top:0.35em;">
  {{day_strings[i][2]}}食谱({{day_strings[i][3]}})
  <span id="small-triangle-{{i}}" class="w3-right">
    {% if i == 1 or i == 2 %} ▴ {% else %} ▾ {% endif %}
    </span>
  </button>
  <div id="accordion-{{i}}" class="w3-hide {% if i == 1 or i == 2 %} w3-show {% endif %} w3-container w3-card-4">
    <form class="w3-container" id="form-plan-content-{{i}}" action="https://monitor.sz.lan/meal_planner/" method="post" style="padding:8px;">
      <input type="hidden" name="date" value="{{i}}"> 
      {%for j in range(0, meal_plans[i]|length)%} 
      <div><p id="title-{{i}}{{j}}" class="w3-text-green" style="margin-top:0.5em; margin-bottom:0.1em"><b>{{meal_plan_items_cn[j]}}</b></p></div>
      <div class="w3-cell-row">
        <div class="w3-cell">
          <textarea id="textarea-{{i}}{{j}}" class="w3-input" name="{{meal_plan_items[j]}}" rows="{{textarea_heights[j]}}" form="form-plan-content-{{i}}" style="width:99%;">{{meal_plans[i][j][0]}}</textarea>
          <!-- You cannot simply break textarea, otherwise those spaces will appears on the webpage.-->
        </div>
        <div class="w3-cell">
          <select 
            {% if meal_plans[i][j][1] != 'A' and 
                  meal_plans[i][j][1] != 'A-' and
                  meal_plans[i][j][1] != 'B+' and 
                  meal_plans[i][j][1] != 'B' and 
                  meal_plans[i][j][1] != 'C' %} class="w3-select w3-text-black" style="font-weight:bold;" 
            {% elif meal_plans[i][j][1] == 'A' %} class="w3-select w3-text-green" style="font-weight:bold;" 
            {% elif meal_plans[i][j][1] == 'A-' %} class="w3-select" style="color:#60a917;font-weight:bold;" 
            {% elif meal_plans[i][j][1] == 'B+' %} class="w3-select" style="color:#bac100;font-weight:bold;" 
            {% elif meal_plans[i][j][1] == 'B' %} class="w3-select" style="color:#f2552c;font-weight:bold;" 
            {% elif meal_plans[i][j][1] == 'C' %} class="w3-select w3-text-red" style="font-weight:bold;"
            {% endif %} 
             name="{{meal_plan_items[j]}}_review">
  					<option class="w3-text-black" style="font-weight:bold;" 
  					{% if meal_plans[i][j][1] != 'A' and 
  					      meal_plans[i][j][1] != 'A-' and 
  					      meal_plans[i][j][1] != 'B+' and 
  					      meal_plans[i][j][1] != 'B' and 
  					      meal_plans[i][j][1] != 'C' %} selected {% endif %} 
  					value="-">-</option>
            <option class="w3-text-green" style="font-weight:bold;" {% if meal_plans[i][j][1] == 'A' %} selected {% endif %} value="A">A</option>  
            <option style="font-weight:bold;color:#60a917;" {% if meal_plans[i][j][1] == 'A-' %} selected {% endif %} value="A-">A-</option>  
            <option style="font-weight:bold;color:#bac100;" {% if meal_plans[i][j][1] == 'B+' %} selected {% endif %} value="B+">B+</option><!-- total self-selected -->
            <option style="font-weight:bold;color:#f2552c;" {% if meal_plans[i][j][1] == 'B' %} selected {% endif %} value="B">B</option><!--w3-2017-flame-->
            <option class="w3-text-red" style="font-weight:bold;" {% if meal_plans[i][j][1] == 'C' %} selected {% endif %} value="C">C</option>
          </select>
        </div>
      </div>
      {%endfor%}
      <div><p class="w3-text-green" style="margin-top:0.5em; margin-bottom:0.1em"><b>今日备注</b></p></div>
      <div class="w3-cell-row">
        <div class="w3-cell">
          <textarea id="textarea-daily-remarks-{{i}}" class="w3-input" name="daily_remark" rows="8" form="form-plan-content-{{i}}" style="width:99%;">{{daily_remarks[i]}}</textarea>
        </div>
       </div>
      <input class="w3-button w3-border w3-highway-green w3-right w3-margin-bottom" style="margin-top:0.85rem" type="submit"
        onclick="logUserActivity('[meal-planner/index] submit new meal plan', '{{username}}');" value="提交" >
      {% if i == 2 %}
        <input class="w3-button w3-border w3-highway-green w3-right w3-margin-bottom" style="margin-top:0.85rem;" type="button" onclick="copyMealPlanOfToday();" value="沿用今日">
      {% endif %}
    </form>    
  </div>
	{%endfor%}
  <button onclick="accordionHandler('notes')" class="w3-button w3-block w3-left-align w3-green" style="margin-top:0.35em;">
  饮食健康笔记
  <span id="small-triangle-notes" class="w3-right"> ▾ 
    </span>
  </button>
  <div id="accordion-notes" class="w3-hide w3-container w3-card-4">
    <div class="w3-container">
      <form action="https://monitor.sz.lan/meal_planner/" method="post" style="padding:8px;" id="form-notes">
        <div><textarea rows="18" name="notes" form="form-notes" style="width:99%;">{{notes}}</textarea></div>
        <input class="w3-button w3-border w3-highway-green w3-right w3-margin-bottom" style="margin-top: 0.85rem" type="submit"
          onclick="logUserActivity('[meal-planner/index] submit new notes', '{{username}}');" value="提交">
      </form>
    </div>  
  </div>
	<div class="w3-card-4" style="margin-top:1rem;" >
    <header class="w3-container w3-green">
      <h3>黑名单</h3>
    </header>  
    <div class="w3-container">
      <form action="https://monitor.sz.lan/meal_planner/" method="post" style="padding:8px;" id="form-blacklist">
        <div class="w3-container" style="margin-top:1rem;">
          <span style="color:#ff0000;"><!--pure-red--><b>避免</b>食用</span>
          <textarea rows="11" name="banned_items" form="form-blacklist" style="width:99%;">{{banned_items}}</textarea>
        </div>
        <div class="w3-container"><span style="color:#f2552c;"><!--w3-2017-flame--><b>谨慎</b>食用</span>
          <textarea rows="7" name="limited_items" form="form-blacklist" style="width:99%;">{{limited_items}}</textarea>
        </div>
        <input class="w3-button w3-border w3-highway-green w3-right w3-margin-bottom" style="margin-top: 0.85rem" type="submit" 
          onclick="logUserActivity('[meal-planner/index] submit new blacklist items', '{{username}}');" value="提交">
      </form>      
    </div>  
  </div>
  <div id="msg-box" class="w3-modal" style="display:none">
    <div class="w3-modal-content w3-animate-top">
      <header class="w3-container w3-green"> 
        <h4>每日一提醒</h4>
      </header>
      <div class="w3-container">
        <p id="msg-body" style="font-size:large;"></p>
        <p>
          <button id="button-okay" onclick="closeDailyReminder();" class="w3-right w3-button w3-green" disabled>
            确定(<span id="count"></span>)
          </button>
        </p>
      </div>
    </div>
  </div>
  <div class="fixed-footer">
    <div class="w3-cell-row">
    全A天数：<span style="font-size:30px">{{days}},</span>&nbsp;{{dayss}}
    </div>
  </div>
</div>
<script>

function logout() {
  logUserActivity('[meal-planner/index] logout', '{{username}}');
  window.location.replace('../meal_planner/logout/');
}

function closeDailyReminder() {
  document.getElementById('msg-box').style.display='none';
  logUserActivity('[meal-planner/index] daily reminder closed', '{{username}}');
}

function showDailyReminder() {

  {% if show_reminder == True %}
  document.getElementById('msg-box').style.display='block';
  
  {% else %}
  document.getElementById('msg-box').style.display='none';
  return;
  {% endif %}
  var spn = document.getElementById("count");
  var btn = document.getElementById("button-okay");
  
  var count = 5;
  var timer = null;  // For referencing the timer
  
  var remindersList = [
    '修改前想一想：一定要今天改吗？明天改会不会更好？',
    '反思一下，连续几天A了？是不是又要接近出事了？',
    '即使昨天肠胃很舒服，也可以等明天再加，对不对？着急一天，有什么用呢？',
    '饿的时候，想想拉肚子的时候。',
    '连续几天A了？会不会，又开始着急了？',
    '不要心急。',
    '选A的时候要想想：是A还是A-？',
    '食谱要准确，不然就是自欺欺人。',
    '回想一下，上次拉肚子是什么时候，原因是什么？',
    '最好可以朗读每日一提醒的内容',
    '不要忘记昨天晚上的反馈，有时候可能会漏掉',
    '定期翻看一下备忘和黑名单。对于过期的内容，要及时删除。',
    '修改食谱要提前进行，不可把食物从冰箱里拿出来了才想到改。'];
  reminderID = Math.floor(Math.random() * remindersList.length);
  document.getElementById("msg-body").innerHTML = remindersList[reminderID];
  logUserActivity('[meal-planner/index] daily reminder [' + remindersList[reminderID] + '] shown', '{{username}}');
  
  (function countDown(){
    // Display counter and start counting down
    spn.textContent = count;
    
    // Run the function again every second if the count is not zero
    if(count !== 0){
      timer = setTimeout(countDown, 1000);
      count--; // decrease the timer
    } else {
      // Enable the button
      btn.removeAttribute("disabled");
    }
  }());
}

function accordionHandler(id) {
  var x = document.getElementById('accordion-' + id.toString());
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
    document.getElementById('small-triangle-' + id.toString()).innerHTML = '▴';
    logUserActivity('[meal-planner/index] accordion ' + id.toString() + ' shown', '{{username}}');
  } else { 
    x.className = x.className.replace(" w3-show", "");
    document.getElementById('small-triangle-' + id.toString()).innerHTML = '▾';
    logUserActivity('[meal-planner/index] accordion ' + id.toString() + ' hidden', '{{username}}');
  }
}

function copyMealPlanOfToday() {
  for (i = 0; i < {{meal_plan_items|length}}; i++) {
    document.getElementById('textarea-2' + i.toString()).value = document.getElementById('textarea-1' + i.toString()).value;
  }
  document.getElementById('textarea-daily-remarks-2').value = document.getElementById('textarea-daily-remarks-1').value;
  logUserActivity('[meal-planner/index] copy today\'s meal plan', '{{username}}');
}

function checkDifference() {
  var changeCount = 0;
  var warningMessages = ['<span style="color:red;">&nbsp(第1处修改，如果是增加，最好<span style="font-weight:bold;text-decoration:underline;">3天一次</span>)</span>',
                         '<span style="color:red;">&nbsp(第2处修改？不改了吧？？)',
                         '<span style="color:red;font-weight:bold;">&nbsp(第3处修改？留到明天不行？？)</span>',
                         '<span style="color:red;font-weight:bold;">&nbsp(第4处？？！！！要干嘛？？？)</span>',
                         '<span style="color:red;font-weight:bold;">&nbsp(？？？？？？？！！！！)</span>', 
                         '<span style="color:red;font-weight:bold;">&nbsp(。。。。。。。。。。。)</span>',
                         '<span style="color:red;font-weight:bold;">&nbsp(。。。。。。。。。。。)</span>'];
  for (i = 0; i < {{meal_plan_items|length}}; i++) {
    yesterday = document.getElementById('textarea-0' + i.toString()).value.replace(/[0-2][0-9][0-5][0-9]/, '')
    today = document.getElementById('textarea-1' + i.toString()).value.replace(/[0-2][0-9][0-5][0-9]/, '');

    if (yesterday != today) {
      document.getElementById('title-1' + i.toString()).innerHTML = 
        document.getElementById('title-1' + i.toString()).innerHTML + warningMessages[changeCount];
      changeCount += 1;
    }
  }
}
</script>
</body>
</html>